[gcode_macro CHECK_IF_SHOULD_PAUSE]
gcode:
    {% if printer['gcode_macro _STOP_IF_INCORRECT_TOOL'].should_pause| int == 1%}
       
       SET_GCODE_VARIABLE MACRO=_STOP_IF_INCORRECT_TOOL VARIABLE=should_pause VALUE=0
       M400
       TOOL_FAIL_PAUSE
       Respond msg='//Pausing Due to Tool Error//'
       M104 T0 S0
       M104 T1 S0
       M104 T2 S0
       M104 T3 S0
       M104 T4 S0
       
    {% else %}

        Respond msg='//Do not need to pause//'
     
     {% if printer[printer.toolhead.extruder].target|int > 150 %}
    
         TEMPERATURE_WAIT sensor={printer.toolhead.extruder|string} minimum={printer[printer.toolhead.extruder].target|int}      
         _clean_nozzle_gantry
         RESPOND msg='Cleaning Nozzle'
         
    {% else %}
    
       RESPOND msg="Not Cleaning Nozzle"
       
    {% endif %}   
  {% endif %}

[gcode_macro TOOL_FAIL_PAUSE]
gcode:
    
    M400
    PAUSE_BASE

[gcode_macro _CLEAN_NOZZLE_GANTRY]
gcode:
   SAVE_GCODE_STATE NAME=clean_nozzle_gantry
   G90
   SET_VELOCITY_LIMIT ACCEL=12000 ACCEL_TO_DECEL=6000
   G0 Y360 X68.7 F6000
   G0 Y357.5 X107.7 F6000
   G0 Y360 F6000
   G0 y357.7 X68.7 F6000
   G0 Y360 F6000
   G0 y357.7 X107.7 F6000
   G0 Y360 X68.7 F6000
   G0 y357.7 F6000
   G0 Y360 X107.7 F6000
   G0 y357.7 F6000
   g0 x68.7 F6000
   g0 Y360 F6000
   g0 x107.7 F6000
   g0 x68.7 F6000
   g0 y357.7 F6000
   g0 x107.7 F6000
   g0 Y360 F6000
   RESTORE_GCODE_STATE NAME=clean_nozzle_gantry

[gcode_macro HOME_AFTER_QGL]
gcode:
   {% if printer.quad_gantry_level.applied|lower == 'true' %}
        
        g0 x320 y320 z10 f20000
        g28
    {% endif %}

[gcode_macro M106]
description: Override for Fan Speed. Store Fan Speed for later reuse.
rename_Existing: M106.1
variable_fan_speed: 0

gcode:
    {% set specified = params.specified|default(0)|int %}
    {% set target = params.S|default(0)|int %}
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=fan_speed VALUE={target}
    M106.1 S{target}
 

[gcode_macro STORE_FAN_SPEED]
description: Set system Fan Speed to the value last stored with M106.
variable_stored_speed: 0
gcode:
    SET_GCODE_VARIABLE MACRO=STORE_FAN_SPEED VARIABLE=stored_speed VALUE={printer["gcode_macro M106"].fan_speed}

[gcode_macro RESTORE_FAN]
description: Set system Fan Speed to the value last stored with M106.
gcode:
    M106.1 S{printer["gcode_macro STORE_FAN_SPEED"].stored_speed}

 